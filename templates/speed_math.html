{% extends 'base.html' %}

{% block title %}Speed Math - Brain Training{% endblock %}

{% block extra_css %}
<style>
  /* Additional styles specific to speed math game */
  .math-problem {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      margin: 2rem 0;
  }
  
  .answer-input {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
  }
  
  .answer-input input {
      font-size: 1.5rem;
      padding: 0.75rem 1rem;
      width: 150px;
      text-align: center;
      border: 2px solid var(--purple-300);
      border-radius: 0.5rem;
      margin-right: 0.5rem;
  }
  
  .answer-input input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
  }
  
  .answer-input button {
      font-size: 1.25rem;
  }
  
  .game-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
  }
  
  .stat-box {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .stat-box p:first-child {
      font-size: 0.875rem;
      color: var(--gray-500);
      margin-bottom: 0.5rem;
  }
  
  .stat-box p:last-child {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--gray-900);
      margin: 0;
  }
  
  .timer-bar {
      height: 8px;
      background-color: var(--gray-200);
      border-radius: 4px;
      margin-bottom: 2rem;
      overflow: hidden;
  }
  
  .timer-fill {
      height: 100%;
      background-color: var(--purple-500);
      width: 100%;
      transition: width 0.1s linear;
  }
  
  .operation-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
  }
  
  .difficulty-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
  }
  
  .game-controls {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .game-controls h3 {
      margin-top: 0;
      margin-bottom: 1rem;
  }
  
  .game-board {
      background-color: white;
      border-radius: 0.5rem;
      padding: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      text-align: center;
  }
  
  .welcome-message {
      text-align: center;
      padding: 3rem 2rem;
  }
  
  .welcome-message svg {
      margin-bottom: 1.5rem;
      color: var(--purple-500);
  }
  
  .welcome-message h2 {
      margin-bottom: 1rem;
  }
  
  .welcome-message p {
      margin-bottom: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
  }
  
  .hidden {
      display: none;
  }
</style>
{% endblock %}

{% block content %}
<!-- Display messages if any -->
{% if messages %}
<div class="messages-container">
  {% for message in messages %}
  <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
      {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Header -->
<header class="game-header purple-gradient">
  <div class="container">
      <div class="game-header-content">
          <a href="{% url 'games_list' %}" class="back-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
          </a>
          <div>
              <h1><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Speed Math</h1>
              <p>Aqliy hisoblash qobiliyatingizni sinab ko'ring va yaxshilang. Ballarni to'plash uchun matematik muammolarni tez va aniq hal qiling</p>
          </div>
      </div>
  </div>
</header>

<!-- Game Area -->
<main class="container game-container">
  <!-- Game Controls -->
  <div class="game-controls">
      <h3>O'yin Sozlamalari</h3>
      <div class="control-group">
          <label>Amallar:</label>
          <div class="operation-buttons">
              <button class="btn btn-purple active" data-operation="addition">Qo'shish (+)</button>
              <button class="btn btn-outline" data-operation="subtraction">SubtracAyirishtion (-)</button>
              <button class="btn btn-outline" data-operation="multiplication">Ko'paytirish (ร)</button>
              <button class="btn btn-outline" data-operation="division">Bo'lish (รท)</button>
              <button class="btn btn-outline" data-operation="mixed">Aralash</button>
          </div>
      </div>
      <div class="control-group">
          <label>Difficulty:</label>
          <div class="difficulty-buttons">
              <button class="btn btn-purple active" data-difficulty="easy">Oson</button>
              <button class="btn btn-outline" data-difficulty="medium">O'rtacha</button>
              <button class="btn btn-outline" data-difficulty="hard">Qiyin</button>
          </div>
      </div>
      <div class="control-group">
          <label>O'yin Davomiyligi:</label>
          <div class="duration-slider">
              <input type="range" id="duration-slider" min="30" max="180" step="30" value="60">
              <span id="duration-value">60 seconds</span>
          </div>
      </div>
      <button id="start-game" class="btn btn-primary btn-lg">Boshlash</button>
  </div>

  <!-- Game Board -->
  <div id="game-board" class="game-board hidden">
      <!-- Timer Bar -->
      <div class="timer-bar">
          <div id="timer-fill" class="timer-fill"></div>
      </div>
      
      <!-- Game Stats -->
      <div class="game-stats">
          <div class="stat-box">
              <p>Vaqt qoldi</p>
              <p id="time-left">60s</p>
          </div>
          <div class="stat-box">
              <p>Ball</p>
              <p id="score">0</p>
          </div>
          <div class="stat-box">
              <p>To'g'ri</p>
              <p id="correct">0</p>
          </div>
          <div class="stat-box">
              <p>Not'g'ri</p>
              <p id="incorrect">0</p>
          </div>
      </div>
      
      <!-- Math Problem -->
      <div id="math-problem" class="math-problem">8 + 5 = ?</div>
      
      <!-- Answer Input -->
      <div class="answer-input">
          <input type="number" id="answer-input" placeholder="AnswJavober" autofocus>
          <button id="submit-answer" class="btn btn-primary">Yuborish</button>
      </div>
  </div>
  
  <!-- Welcome Message -->
  <div id="welcome-message" class="welcome-message">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
      <h2>Speed Math o'yiniga xush kelibsiz!</h2>
      <p>Aqliy hisoblash qobiliyatingizni sinab ko'ring va yaxshilang.O'zingiz yoqtirgan amalni, qiyinchilik darajasini va o'yin davomiyligini tanlang, so'ngra boshlash uchun "Boshlash" tugmasini bosing.</p>
      <button id="welcome-start" class="btn btn-purple btn-lg">Boshlash</button>
  </div>
</main>

<!-- Results Modal -->
<div id="results-modal" class="modal">
  <div class="modal-content">
      <div class="modal-header">
          <h2>O'yin tugadi!</h2>
          <p>Speed Math o'yini qanday ishlaydi</p>
      </div>
      <div class="modal-body">
          <div class="results-container">
              <h3>Izning Natijangiz</h3>
              <div class="results-grid">
                  <div class="result-box">
                      <p>Ball</p>
                      <p id="result-score" class="result-value">0</p>
                  </div>
                  <div class="result-box">
                      <p>To'g'ri</p>
                      <p id="result-correct" class="result-value">0</p>
                  </div>
                  <div class="result-box">
                      <p>Noto'g'ri</p>
                      <p id="result-incorrect" class="result-value">0</p>
                  </div>
                  <div class="result-box">
                      <p>Aniqlik</p>
                      <p id="result-accuracy" class="result-value">0%</p>
                  </div>
              </div>
          </div>
          <p class="results-message">O'z balingizni yaxshilay olasizmi? Qayta urunib ko'ring yoki qiyinchilik darajasini oshiring.</p>
          
          <!-- Save Score Form - Direct POST without forms.py -->
          <form action="{% url 'save_speed_math_score' %}" method="post" class="save-score-form">
              {% csrf_token %}
              <input type="hidden" name="game_name" value="Speed Math">
              <input type="hidden" id="form-score" name="score" value="">
              <input type="hidden" id="form-correct" name="correct_answers" value="">
              <input type="hidden" id="form-incorrect" name="incorrect_answers" value="">
              <input type="hidden" id="form-accuracy" name="accuracy" value="">
              <input type="hidden" id="form-difficulty" name="difficulty" value="">
              <input type="hidden" id="form-operation" name="operation" value="">
              
              <div class="modal-footer">
                  <button type="button" id="play-again" class="btn btn-outline">Yana O'ynash</button>
                  <button type="submit" id="save-score" class="btn btn-purple">Natijalarni Saqlash</button>
              </div>
          </form>
      </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Game variables
      let gameStarted = false;
      let gameInterval;
      let timeLeft = 60;
      let score = 0;
      let correctAnswers = 0;
      let incorrectAnswers = 0;
      let currentProblem = {};
      let operation = 'addition';
      let difficulty = 'easy';
      
      // DOM elements
      const gameBoard = document.getElementById('game-board');
      const welcomeMessage = document.getElementById('welcome-message');
      const startGameBtn = document.getElementById('start-game');
      const welcomeStartBtn = document.getElementById('welcome-start');
      const mathProblem = document.getElementById('math-problem');
      const answerInput = document.getElementById('answer-input');
      const submitAnswerBtn = document.getElementById('submit-answer');
      const timeLeftDisplay = document.getElementById('time-left');
      const scoreDisplay = document.getElementById('score');
      const correctDisplay = document.getElementById('correct');
      const incorrectDisplay = document.getElementById('incorrect');
      const timerFill = document.getElementById('timer-fill');
      const durationSlider = document.getElementById('duration-slider');
      const durationValue = document.getElementById('duration-value');
      const operationBtns = document.querySelectorAll('[data-operation]');
      const difficultyBtns = document.querySelectorAll('[data-difficulty]');
      const resultsModal = document.getElementById('results-modal');
      const resultScore = document.getElementById('result-score');
      const resultCorrect = document.getElementById('result-correct');
      const resultIncorrect = document.getElementById('result-incorrect');
      const resultAccuracy = document.getElementById('result-accuracy');
      const playAgainBtn = document.getElementById('play-again');
      
      // Form elements for saving score
      const formScore = document.getElementById('form-score');
      const formCorrect = document.getElementById('form-correct');
      const formIncorrect = document.getElementById('form-incorrect');
      const formAccuracy = document.getElementById('form-accuracy');
      const formDifficulty = document.getElementById('form-difficulty');
      const formOperation = document.getElementById('form-operation');
      
      // Update duration value display
      durationSlider.addEventListener('input', function() {
          durationValue.textContent = `${this.value} seconds`;
          timeLeft = parseInt(this.value);
      });
      
      // Operation buttons
      operationBtns.forEach(btn => {
          btn.addEventListener('click', function() {
              operationBtns.forEach(b => {
                  b.classList.remove('active', 'btn-purple');
                  b.classList.add('btn-outline');
              });
              this.classList.remove('btn-outline');
              this.classList.add('active', 'btn-purple');
              operation = this.dataset.operation;
          });
      });
      
      // Difficulty buttons
      difficultyBtns.forEach(btn => {
          btn.addEventListener('click', function() {
              difficultyBtns.forEach(b => {
                  b.classList.remove('active', 'btn-purple');
                  b.classList.add('btn-outline');
              });
              this.classList.remove('btn-outline');
              this.classList.add('active', 'btn-purple');
              difficulty = this.dataset.difficulty;
          });
      });
      
      // Start game buttons
      startGameBtn.addEventListener('click', startGame);
      welcomeStartBtn.addEventListener('click', startGame);
      
      // Submit answer
      submitAnswerBtn.addEventListener('click', checkAnswer);
      answerInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              checkAnswer();
          }
      });
      
      // Play again button
      playAgainBtn.addEventListener('click', function() {
          resultsModal.classList.remove('show');
          resetGame();
          startGame();
      });
      
      // Start game function
      function startGame() {
          // Reset game state
          resetGame();
          
          // Hide welcome message, show game board
          welcomeMessage.classList.add('hidden');
          gameBoard.classList.remove('hidden');
          
          // Set time left from slider
          timeLeft = parseInt(durationSlider.value);
          timeLeftDisplay.textContent = `${timeLeft}s`;
          
          // Generate first problem
          generateProblem();
          
          // Focus on answer input
          answerInput.focus();
          
          // Start timer
          gameStarted = true;
          gameInterval = setInterval(updateTimer, 1000);
      }
      
      // Reset game function
      function resetGame() {
          clearInterval(gameInterval);
          gameStarted = false;
          score = 0;
          correctAnswers = 0;
          incorrectAnswers = 0;
          timeLeft = parseInt(durationSlider.value);
          
          // Reset displays
          scoreDisplay.textContent = '0';
          correctDisplay.textContent = '0';
          incorrectDisplay.textContent = '0';
          timeLeftDisplay.textContent = `${timeLeft}s`;
          timerFill.style.width = '100%';
          
          // Clear answer input
          answerInput.value = '';
      }
      
      // Update timer function
      function updateTimer() {
          timeLeft--;
          timeLeftDisplay.textContent = `${timeLeft}s`;
          
          // Update timer bar
          const percentage = (timeLeft / parseInt(durationSlider.value)) * 100;
          timerFill.style.width = `${percentage}%`;
          
          // Check if time is up
          if (timeLeft <= 0) {
              endGame();
          }
      }
      
      // Generate math problem
      function generateProblem() {
          let num1, num2, answer, symbol, problemText;
          
          // Set number ranges based on difficulty
          const ranges = {
              easy: { min: 1, max: 10 },
              medium: { min: 10, max: 50 },
              hard: { min: 50, max: 100 }
          };
          
          const range = ranges[difficulty];
          
          // Generate random operation if mixed
          const currentOperation = operation === 'mixed' 
              ? ['addition', 'subtraction', 'multiplication', 'division'][Math.floor(Math.random() * 4)]
              : operation;
          
          switch (currentOperation) {
              case 'addition':
                  num1 = getRandomNumber(range.min, range.max);
                  num2 = getRandomNumber(range.min, range.max);
                  answer = num1 + num2;
                  symbol = '+';
                  break;
                  
              case 'subtraction':
                  num1 = getRandomNumber(range.min, range.max);
                  num2 = getRandomNumber(range.min, num1); // Ensure positive result
                  answer = num1 - num2;
                  symbol = '-';
                  break;
                  
              case 'multiplication':
                  // Adjust ranges for multiplication to keep problems manageable
                  const multRange = {
                      easy: { min: 1, max: 10 },
                      medium: { min: 2, max: 12 },
                      hard: { min: 5, max: 20 }
                  }[difficulty];
                  
                  num1 = getRandomNumber(multRange.min, multRange.max);
                  num2 = getRandomNumber(multRange.min, multRange.max);
                  answer = num1 * num2;
                  symbol = 'ร';
                  break;
                  
              case 'division':
                  // For division, generate answer first, then multiply to get dividend
                  answer = getRandomNumber(1, 10);
                  num2 = getRandomNumber(1, 10);
                  num1 = answer * num2; // This ensures clean division
                  symbol = 'รท';
                  break;
          }
          
          problemText = `${num1} ${symbol} ${num2} = ?`;
          mathProblem.textContent = problemText;
          
          // Store current problem
          currentProblem = {
              num1,
              num2,
              operation: currentOperation,
              answer,
              symbol
          };
      }
      
      // Check answer function
      function checkAnswer() {
          if (!gameStarted) return;
          
          const userAnswer = parseInt(answerInput.value);
          
          // Check if answer is empty or NaN
          if (isNaN(userAnswer)) {
              answerInput.classList.add('error');
              setTimeout(() => {
                  answerInput.classList.remove('error');
              }, 500);
              return;
          }
          
          // Check if answer is correct
          if (userAnswer === currentProblem.answer) {
              // Correct answer
              correctAnswers++;
              score += getScoreForProblem();
              correctDisplay.textContent = correctAnswers;
              scoreDisplay.textContent = score;
              
              // Visual feedback
              mathProblem.classList.add('correct');
              setTimeout(() => {
                  mathProblem.classList.remove('correct');
              }, 300);
          } else {
              // Incorrect answer
              incorrectAnswers++;
              incorrectDisplay.textContent = incorrectAnswers;
              
              // Visual feedback
              mathProblem.classList.add('incorrect');
              setTimeout(() => {
                  mathProblem.classList.remove('incorrect');
              }, 300);
          }
          
          // Clear input and generate new problem
          answerInput.value = '';
          answerInput.focus();
          generateProblem();
      }
      
      // Get score for problem based on difficulty and operation
      function getScoreForProblem() {
          const baseScores = {
              addition: 1,
              subtraction: 1,
              multiplication: 2,
              division: 2
          };
          
          const difficultyMultipliers = {
              easy: 1,
              medium: 2,
              hard: 3
          };
          
          return baseScores[currentProblem.operation] * difficultyMultipliers[difficulty];
      }
      
      // End game function
      function endGame() {
          clearInterval(gameInterval);
          gameStarted = false;
          
          // Calculate accuracy
          const totalAnswers = correctAnswers + incorrectAnswers;
          const accuracy = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;
          
          // Update results modal
          resultScore.textContent = score;
          resultCorrect.textContent = correctAnswers;
          resultIncorrect.textContent = incorrectAnswers;
          resultAccuracy.textContent = `${accuracy}%`;
          
          // Update form values for submission
          formScore.value = score;
          formCorrect.value = correctAnswers;
          formIncorrect.value = incorrectAnswers;
          formAccuracy.value = accuracy;
          formDifficulty.value = difficulty;
          formOperation.value = operation;
          
          // Show results modal
          resultsModal.classList.add('show');
      }
      
      // Helper function to get random number
      function getRandomNumber(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
      }
  });
</script>
{% endblock %}
